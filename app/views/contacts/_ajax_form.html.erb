<button class="primary-button big-button hidden" data-modal-id="wizard-modal" id="show-modal-button">
  Wizard Modal
</button>
<div id="wizard-modal" class="modal wizard-modal modal-no-js">
  <div class="step-wizard">
    <div class="inner-step" onclick="wizNav(1)">
      <span id="step-1" class="inner-counter">
        1
      </span>
      Details
    </div>
    <div class="inner-step" onclick="wizNav(2)">
      <span id="step-2" class="inner-counter">
        2
      </span>
      Relationship
    </div>
    <div class="inner-step" onclick="wizNav(3)">
      <span id="step-3" class="inner-counter">
        3
      </span>Avatar
    </div>
  </div>
  <div class="modal-header">
    <h2><%= @contact.new_record? ? 'Add' : 'Edit' %> Contact</h2>
  </div>
  <div class="modal-content">
    <%= form_for @contact, remote: true, :html => {:id => "contact-form"} do |f| %>
        <div id="error_explanation">
          <ul>
          </ul>
        </div>

      <div id="detail-form">
        <div class="field">
          <%= f.label :firstname, 'First Name' %><br>
          <%= f.text_field :firstname %>
        </div>
        <div class="field">
          <%= f.label :lastname, 'Last Name' %><br>
          <%= f.text_field :lastname %>
        </div>
        <div class="field">
          <%= f.label :emailaddress, 'Email Address' %><br>
          <%= f.text_field :emailaddress %>
        </div>
        <div class="field">
          <%= f.label :phone %><br>
          <%= f.text_field :phone, class: "form-control", :data => {:mask => '999-999-9999'} %>
        </div>

        <div class="field">
          <%= f.label :contact_type, 'Contact Type' %><br>
          <div class="styled-select">
            <%= f.select :contact_type, options_for_select(Contact::CONTACT_TYPES.keys, @contact.contact_type) %>
          </div>
        </div>
      </div>

      <div id="category-form" class="contact-profile">
        <div id="personal_relationship">
          <div class="field">
            <%= f.label :relationship %><br>
            <div class="styled-select">
              <%= f.select :relationship, 
                options_for_select(Contact::RELATIONSHIP_TYPES[:personal], @contact.relationship),
                {}, id: :personal_relationships_select %>
            </div>
          </div>

          <div class="field">
            <%= f.label :beneficiarytype, 'Beneficiary Type' %><br>
            <%= f.text_field :beneficiarytype %>
          </div>
          <div class="field">
            <%= f.label :birthdate %><br>
            <%= f.date_select :birthdate, 
              use_two_digit_numbers: true,
              selected: 40.years.ago,
              start_year: Date.today.year - 80,
              end_year: Date.today.year,
              order: [:month, :day, :year]
            %>
          </div>
          <div class="field">
            <%= f.label :address, 'Street Address' %><br>
            <%= f.text_field :address %>
          </div>
        </div>

        <div id="professional_relationship">
          <div class="field">
            <%= f.label :relationship %><br>
            <div id="common_professional">
              <div class="styled-select">
                <%= f.select :relationship, 
                  options_for_select(Contact::RELATIONSHIP_TYPES[:professional], @contact.relationship), 
                  {}, id: :professional_relationships_select %>
              </div>
            </div>
            <div id="medical_professional">
              <div class="styled-select">
                <%= f.select :relationship, 
                  options_for_select(Contact::RELATIONSHIP_TYPES[:medical_professional], @contact.relationship), 
                  {}, id: :professional_relationships_select %>
              </div>
            </div>
          </div>

          <div class="field">
            <%= f.label :businessname, 'Business Name' %><br>
            <%= f.text_field :businessname %>
          </div>
          <div class="field">
            <%= f.label :businesswebaddress, 'Business Web Address' %><br>
            <div class="styled-text-input input-prefix-web">
              <%= f.text_field :businesswebaddress %>
            </div>
          </div>
          <div class="field">
            <%= f.label :businessphone, 'Business Phone' %><br>
            <%= f.text_field :businessphone, class: "form-control", :data => {:mask => '999-999-9999'}  %>
          </div>
          <div class="field">
            <%= f.label :businessfax, 'Business Fax' %><br>
            <%= f.text_field :businessfax, class: "form-control", :data => {:mask => '999-999-9999'}  %>
          </div>
          <div class="field">
            <%= f.label :business_street_address, 'Street Address' %><br>
            <%= f.text_field :business_street_address_1 %>
          </div>
        </div>
        <div class="field">
          <label>City</label>
          <div class="styled-text-input">
            <p><%= f.text_field :city %></p>
          </div>
        </div>
        <div class="field address-field">
          <div class="zipcode-field">
            <label>Zip Code </label>
            <div class="zipcode-text styled-input-text">
              <div class="zipcode">
                <p><%= f.text_field :zipcode %></p>
              </div>
            </div>
          </div>
          <div class="state-select">
            <label>State </label>
            <div class="styled-select state">
              <p><%= f.select :state, options_for_select(us_states, f.object.state), :include_blank => "Select..."  %></p>
            </div>
          </div>
        </div>
        <div class="field bottom-field">
          <%= f.label :notes %><br>
          <%= f.text_area :notes %>
        </div>
      </div>
      
      <div id="avatar-form">
        <div class="field">
          <%= f.label :avatarcolor, 'Avatar Color' %><br>
          <%= f.text_field :avatarcolor %>
        </div>
        <div class="field">
          <%= f.label :photourl, 'Photo Url' %><br>
          <%= f.text_field :photourl %>
        </div>
      </div>
    <% end %>
  </div>
  <footer class="modal-footer">
    <a href="javascript:;" id='next-step' class=" button secondary-button big-button" 
    onclick="wizNav(currentStep+1); return false;">Next</a>
    <button id="save-btn" class="js-modal-close secondary-button big-button" onclick="$('#contact-form').submit();">Save</button>
    <%= link_to 'Cancel', "javascript:void(0)", class: "js-modal-close button secondary-button big-button", id: 'close-form-link' %>
    <span class='footer_right'>
      <% if @contact.persisted? %>
        <%= link_to 'Delete', contact_path(@contact), method: :delete, data: { confirm: 'Are you sure?' }, class: "js-modal-close button secondary-button big-button" %>
      <% end %>
    </span>
  </footer>
</div>


<%#= link_to 'Back', contacts_path #%>
<script>

var currentSelectInput = ''; // XXX: This stores which input is selected

var currentStep = 1;

var wizNav = function(step){
  currentStep = step;
  if(step===1){
    $("#next-step").show();
    $("#save-btn").hide();
    $("#detail-form").show();
    $("#avatar-form").hide();
    $("#category-form").hide();
    $("#step-1").removeClass().addClass("inner-counter current-step");
    $("#step-1").html('1');
    $("#step-2").removeClass().addClass("inner-counter");
    $("#step-2").html('2');
    $("#step-3").removeClass().addClass("inner-counter");
    $("#step-3").html('3');
    $(".footer_right > a").css("float", "");
  }
  else if(step===2){
    $("#next-step").show();
    $("#save-btn").hide();
    $("#detail-form").hide();
    $("#category-form").show();
    $("#avatar-form").hide();
    $("#step-1").removeClass().addClass("inner-counter completed-step");
    $("#step-1").html('<svg class="icon circle-icon"><use xlink:href="#icon-checkmark-1"> </use></svg>');
    $("#step-2").removeClass().addClass("inner-counter current-step");
    $("#step-2").html('2');
    $("#step-3").removeClass().addClass("inner-counter");
    $("#step-3").html('3');
    $(".footer_right > a").css("float", "");
  }
  else if(step===3){
    $("#next-step").hide();
    $("#save-btn").show();
    $("#detail-form").hide();
    $("#category-form").hide();
    $("#avatar-form").show();
    $("#step-1").removeClass().addClass("inner-counter completed-step");
    $("#step-1").html('<svg class="icon circle-icon"><use xlink:href="#icon-checkmark-1"> </use></svg>');
    $("#step-2").removeClass().addClass("inner-counter completed-step");
    $("#step-2").html('<svg class="icon circle-icon"><use xlink:href="#icon-checkmark-1"> </use></svg>');
    $("#step-3").removeClass().addClass("inner-counter current-step");
    $("#step-3").html('3');
    $(".footer_right > a").css("float", "right");
  }

  if ($("#contact_contact_type").val() === "Family & Beneficiaries") {
    $('#personal_relationship').show();
    $('#personal_relationships_select').removeAttr("disabled");
    $('#professional_relationship').hide();
    $('#professional_relationships_select').prop('disabled', 'disabled');
  }
  else {
    $('#personal_relationship').hide();
    $('#personal_relationships_select').prop('disabled', 'disabled');
    if ($("#contact_contact_type").val() === "Medical Professional") {
      $('#professional_relationship').show();
      $('#professional_relationships_select').removeAttr("disabled");
      $('#medical_professional').show();
      $('#medical_professional').removeAttr("disabled");
      $('#common_professional').hide();
      $('#common_professional').prop('disabled', 'disabled');
    }
    else {
      $('#professional_relationship').show();
      $('#professional_relationships_select').removeAttr("disabled");
      $('#medical_professional').hide();
      $('#medical_professional').prop('disabled', 'disabled');
      $('#common_professional').show();
      $('#common_professional').removeAttr("disabled");
    }
  }
}

var displayContactFormModal = function() {
  $("body").append("<div class='modal-overlay js-modal-close'></div>");
  $(".modal-overlay").fadeTo(500, 0.8);
  $(".js-modalbox").fadeIn(500);
  canvasEl = $('button[data-modal-id]');
  var modalBox = $(canvasEl).attr('data-modal-id');
  $('#' + modalBox).fadeIn($(canvasEl).data());
  wizNav(1);
}

var handleSelectOnChange = function(selectInput) {
  var selectedOption = $('option:selected:last', selectInput);
  if (selectedOption.val() === 'create_new_contact') {
    currentSelectedInput = $(selectInput);
    // remove 'create_new_contact from select box
    selectedOption.removeAttr('selected');
    $(selectInput).trigger("chosen:updated");
    
    displayContactFormModal();
  } 
}

var closeContactFormModal = function() {
  $(".modal, .modal-overlay").fadeOut(500, function() {
    $("#contact-form").trigger("reset");
    $("#error_explanation ul").empty();
    $(".modal-overlay").remove();
  });
}

var addContactAndCloseModal = function(json) { 
  var select = currentSelectedInput;

  $('.add-new-contactable').each(function(i, obj) {
    $(this).append($('<option>', {
      value: json['id'], 
      text: json['firstname'] + ' ' + json['lastname']
    }));
    $(this).trigger("chosen:updated");
  })

  closeContactFormModal();
}


$(function(){

  $("#contact-form")
    .on("ajax:success", function(e, data, status, xhr) { 
      // XXX: This isn't triggering for some reason
        var newContact = JSON.parse(xhr.responseText);
        return addContactAndCloseModal(newContact);
    })
    .on("ajax:error", function(e, xhr, status, error) {
      var contactErrors = JSON.parse(xhr.responseText);

      // XXX: THIS IS A HUGE HACK
      if (!!contactErrors['id']) { 
        return addContactAndCloseModal(contactErrors)
      }
      for (var key in contactErrors) {
        var errorEl = '<li>' + key + ' ' + contactErrors[key][0] + '</li>';
        $("#error_explanation ul").append(errorEl);
      }
    });

  $("#close-form-link").click(function() { closeContactFormModal(); });
  //ESPECIALLY THIS GARBAGE
  ['.small-modal', '.medium-modal', '.large-modal'].forEach(function(modalClass) {
    $(window).resize(function() {
      $(modalClass).css({
        top: ($(window).height() - $(".modal").outerHeight()) / 2,
        left: ($(window).width() - $(modalClass).outerWidth()) / 2,
      });
    });
  });
  $(window).resize();
});
</script>
