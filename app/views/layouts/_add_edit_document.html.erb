<%= form_for @document, html: { id: "doc-form" } do |f| %>
  <h3 class="document-title"> <%= yield(:title) %> </h3>
  <% if @document.persisted? %>
    <span class='document-change-data'>
      <span class="edit-data-label">Created: </span><%= date_format(@document.created_at) %>
      <span class="edit-data-label">Modified: </span><%= date_format(@document.updated_at) %>
    </span>
  <% end %>
  <div class="card document mb-30">
    <% if @document.errors.any? %>
      <% errors = true %>
    <% end %>
    <% if add_new_document?(yield(:title)) %>
      <label>Attach File</label>
      <% if errors && @document.errors.messages[:url] %>
        <span class="error-label"> - You should select file before saving a document</span>
      <% end %>
      <div id="file-pick-section">
        <input type="filepicker" data-fp-apikey="AU8hye5meSjiQ6l5oOxKFz" data-fp-store-location="S3" data-fp-button-text="Select File"
          data-fp-store-container="zoku-stage" onchange="fileToPage(event)" class="js-modal-close primary-button big-button" data-buttonText="Select file" id="select-file"/>
      </div>
    <% end %>
    <%= f.hidden_field :folder_id %>
    <%= f.hidden_field :url %>

    <label>Document Name</label>
    <% if errors && @document.errors.messages[:name] %>
      <span class="error-label"> - <%= @document.errors.messages[:name].first %></span>
    <% end %>
    <%= f.text_field :name, { class: ("input-error" if @document.errors.messages[:name].present?) } %>

    <label>Category</label>
    <div class="chosen-styled-select">
      <%= f.collection_select :category, 
        CategoryDropdownOptions::CATEGORIES, :to_s, :to_s, {}, 
        { 'data-placeholder' => 'Select...', class: "chosen-select", multiple: false }
      %>
    </div>

    <label>Subcategory</label>
    <div class="chosen-styled-select">
      <%= f.collection_select :group, 
        @cards.collect{|s| [s[0][:id], s[0][:name]]}, :first, :second, {},
        { 'data-placeholder' => 'Select...', class: "chosen-select", multiple: false, blank_value: "Select..." }
      %>
    </div>

    <label>Notes</label>
    <%= f.text_area :description %>

    <section class="shared-with edit-shared">
      <h3 class="card-label shared-label">
        <svg class="icon" viewBox="0 0 20 20">
          <use xlink:href="#icon-Safe"></use>
        </svg> Shared With
      </h3>
      <label>Shared With</label><br>
      <div class="chosen-styled-select">
        <%= contact_select_with_create_new(f, :contact_ids, @contacts_shareable) %>
      </div>
    </section>
  </div>
  
  <button
    class="js-modal-close
      primary-button
      big-button" >
      Save</button>
  <%= link_to "Cancel", document_return_path(@document),
    {class: "js-modal-close button secondary-button big-button"} %>
  <% if !add_new_document?(yield(:title)) %>
    <%= link_to 'Delete', document_path(@document), method: :delete, data: { confirm: 'Are you sure?' },
      class: "button outline-button big-button fr"%>
  <% end %>
<% end %>

<script>
  var fileToPage = function(evt){
    var documentNameField = document.getElementById("document_name");
    var documentUrl = document.getElementById("document_url");
    documentNameField.value = evt.fpfile.filename;
    documentUrl.value = evt.fpfile.key;
  }
  
  $('.chosen-select').chosen()
  function showForm() { 
    $('#form-fields').show();
    $('#upload-will-message').hide();
  }

  function showUploadMessage() { 
    $('#form-fields').hide();
    $('#upload-will-message').show();
  }
  
  //get ajax request to update card drop down info based on chosen category
  $("#document_category.chosen-select").chosen().change(function(e, params){
    var url = '/documents/get_drop_down_options/' + params.selected.replace('...', '');
    $.get(url, function(data) {
      card_values = $('#document_group');
      card_values.empty();
      data.forEach(function(group){
        card_values.append("<option value='" + group.id + "'>" + group.name + "</option>");
      });
      card_values.trigger('chosen:updated');
    });
  })
</script>
<%= yield :new_contact_form %>
